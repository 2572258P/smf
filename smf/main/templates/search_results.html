{% extends 'base_frame.html' %}
{% load static %}
{% load main_extras %}

{% block head_block %}
<script>
$(document).ready(function()
{   
    {% for sr in search_entities %}        
    $("#sendbt_{{sr.pf_pk}}").click(function()
    {
        
        var msg_ = $("#msgtxt_{{sr.pf_pk}}").val();
        if(msg_.length > 0)
        {
            if(msg_[0] == '#')
            {
                msg_ = "";
            }
        }            
        $("#img_prog_{{sr.pf_pk}}").attr("src","{% static 'loading4.gif' %}");
        $.ajax({
                type: "POST",
                url: "{% url 'main:page_search_result' 'dummy' %}",
                data:{
                    pf_pk: '{{sr.pf_pk}}',
                    msg: msg_,                        
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    percent: $("#percent_{{sr.pf_pk}}").html(),
                    dataType: "json",
                },
                success: function (data)
                {
                    $("#req_div_{{sr.pf_pk}}").hide();
                    $("#req_ip_{{sr.pf_pk}}").hide();
                    $("#img_status_{{sr.pf_pk}}").attr("src","{% static 'check1.jpg' %}");
                    $("#status_{{sr.pf_pk}}").html("Requesting has been complete.");                        
                },
                failure: function ()
                {                    
                }
            });
            
    });
    {% endfor %}

});
</script>
{% endblock %}

{% block body_block %}
<style>
    .col_but{
        width: 70%;
        padding: 5px;
        
    }
    .send_div{
        align-items:flex-end;        
    }

    .text_box{        
        border: 1px;
        border-style:dotted;
        display: inline;     
        color: rgb(69, 69, 69);   
        font-weight: normal;
    }

    .img_req{
        width:60px;        
    }

    .img_req:hover{
        width:60px;
    }

    .img_status{
        width:43px;
    }

    .table_div 
    {
        width: 800px;
    }
    .table_div th {
        text-align: left;
        padding: 3px;
}
    
</style>
    {% if search_entities %}
        {% for se in search_entities %}
            <button class="btn btn-primary col_but" id = "rbt_{{se.pf_pk}}" type="button" class="btn btn-info" data-toggle="collapse" data-target="#rt_{{se.pf_pk}}">User / <span id="percent_{{se.pf_pk}}">{{se.percent}}</span> %</button>
            
            {% if forloop.counter0 == 0 %}
                <script> $("#rbt_{{se.pf_pk}}").html("My Answers") </script>
            {% endif %}
            <div id="rt_{{se.pf_pk}}" class="collapse">
                
                {% for k,v in se.cat_info.items %}
                <span>{{v.label}} : {{v.per}}%</span>
                {% endfor %}

                <p>
                    {% for qt in se.QTs%}
                    <p>Q) {{qt}}
                        {% for anss in se.Anss|get_val_in_list:forloop.counter0 %}
                            A) <span style="font-weight:bold;">{{anss}}</span>
                        {% endfor %}
                    </p>
                    {% endfor %}
                    <span style="font-weight: bold;">Profile Text: </span>{{se.profile_text}}
                </p>
                {% if forloop.counter0 > 0 %}
                
                <input id = "req_ip_{{se.pf_pk}}" src="{% static 'group2.png' %}" data-toggle="collapse" data-target="#req_div_{{se.pf_pk}}" class="img_req" type="image" />
                <a href="{% url 'main:page_mymates' %}"><img id="img_status_{{se.pf_pk}}" class="img_status"></a>
                <span id="status_{{se.pf_pk}}" style="font-style:italic"></span><br>                
                <div id="req_div_{{se.pf_pk}}" class="collapse">
                    <p>
                        <table class="table_div">
                            <tr>
                              <th><textarea class="form-control text_box" id="msgtxt_{{se.pf_pk}}" rows="1" class="textarea_title" placeholder="#(Message Optional) Request will be sent to the user annonmously"></textarea></th>
                              <th><button id="sendbt_{{se.pf_pk}}"  type="button" class="btn btn-success" data-toggle="button" aria-pressed="false" autocomplete="off">Request</button>
                                <img id="img_prog_{{se.pf_pk}}" class="img_status"></th>
                              
                            </tr>
                        </table>
                        <script>
                            var msgs = {
                                "req":"* Requesting has been complete.",
                                "rev":"* You have a request from this user.",
                                "con":"* You both are connected.",
                            };
                            var sources = {
                                "req":"{% static 'check1.jpg' %}",
                                "rev":"{% static 'mail.png' %}",
                                "con":"{% static 'hand_shake.jpg' %}",
                            }
                            var status = "";
                            
                            {% if sent|get_val_in_dict:se.pf_pk %}
                                status = 'req';                                
                            {% endif %}
                            {% if rev|get_val_in_dict:se.pf_pk %}
                                status = 'rev';
                            {% endif %}
                            {% if con|get_val_in_dict:se.pf_pk %}
                                status = 'con';
                            {% endif %}
                            if(status.length > 0)
                            {
                                $("#req_ip_{{se.pf_pk}}").hide()
                                $("#status_{{se.pf_pk}}").html(msgs[status]);
                                $("#img_status_{{se.pf_pk}}").attr("src",sources[status]);
                            }
                        </script>

                    </p>
                </div>
                {% endif %}
    
            </div>
            
        {% endfor %}
    {% else %}
        No one matched.
    {% endif %}
{% endblock %}